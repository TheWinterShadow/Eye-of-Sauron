version: "3.8"

# REFERENCE ONLY - NOT USED FOR DEPLOYMENT
# This file shows the equivalent docker compose configuration
# The Raspberry Pi will use 'docker run' commands instead

networks:
  monitoring:
    driver: bridge

volumes:
  alloy_data:
  collector_data:

services:
  github-actions-exporter:
    image: thewintershadow/github-actions-exporter:latest
    container_name: github-actions-exporter
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_ORGAS=${GITHUB_ORGAS}
      - GITHUB_USERS=${GITHUB_USERS:-}
      - GITHUB_REPOS=${GITHUB_REPOS:-}
    networks:
      - monitoring
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9999/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3

  github-actions-collector:
    image: thewintershadow/github-actions-collector:latest
    container_name: github-actions-collector
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_ORGAS=${GITHUB_ORGAS}
      - GITHUB_USERS=${GITHUB_USERS:-}
      - GITHUB_REPOS=${GITHUB_REPOS:-}
      - LOKI_URL=${LOKI_URL}
      - LOKI_USER=${LOKI_USER}
      - LOKI_API_KEY=${LOKI_API_KEY}
      - POLL_INTERVAL=${POLL_INTERVAL:-300}
      - BACKFILL_DAYS=${BACKFILL_DAYS:-30}
    volumes:
      - collector_data:/data
    networks:
      - monitoring
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /data/collector_state.json && test $(($(date +%s) - $(stat -c %Y /data/collector_state.json))) -lt 600"]
      interval: 60s
      timeout: 10s
      retries: 3

  grafana-alloy:
    image: thewintershadow/grafana-alloy:latest
    container_name: grafana-alloy
    environment:
      - GRAFANA_CLOUD_PROMETHEUS_URL=${GRAFANA_CLOUD_PROMETHEUS_URL}
      - GRAFANA_CLOUD_PROMETHEUS_USER=${GRAFANA_CLOUD_PROMETHEUS_USER}
      - GRAFANA_CLOUD_API_KEY=${GRAFANA_CLOUD_API_KEY}
    volumes:
      - alloy_data:/var/lib/alloy
    ports:
      - "12345:12345"
    networks:
      - monitoring
    depends_on:
      - github-actions-exporter
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:12345/ready"]
      interval: 15s
      timeout: 5s
      retries: 5
